<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 창</title>
    <link rel="stylesheet" href="../css/payment.css">
    <script>
        function loadHTML(file) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200 || rawFile.status == 0) {
                        var allText = rawFile.responseText;
                        document.write(allText);
                    }
                }
            }
            rawFile.send(null);
        }
    </script>
</head>

<body>
    <header>
        <script>loadHTML("./header.html")</script>
    </header>
    <section class="payment-top">
        <div class="containers">
            <div class="payment-head">
                결제정보 > 확인+구매
            </div>
        </div>
    </section>

    <!-- 결제 항목 리스트 -->
    <section class="payment-details">
        <div class="containers">

            <div class="container">
                <div>
                    <div class="cart-item">
                        <img src="https://via.placeholder.com/80x50" alt="Potion Craft">
                        <div class="item-details">
                            <div>Potion Craft</div>
                            <div>₩8,600</div>
                        </div>
                    </div>

                    <div class="cart-item">
                        <img src="https://via.placeholder.com/80x50" alt="Muse Plus">
                        <div class="item-details">
                            <div>Muse Plus</div>
                            <div>₩42,000</div>
                        </div>
                    </div>

                </div>

                <div class="total">
                    <p>소계: ₩50,600</p>
                    <p>합계: ₩50,600 (모든 가격은 VAT 포함)</p>
                </div>

                <div class="point-box">
                    <span>이 구매로 UNION 포인트를 획득하세요</span>
                    <span>3,768 포인트</span>
                </div>

                <div class="payment-method">
                    <span>결제 수단: 신용카드(한국 국내)</span>
                    <span>UNION 계정: user01</span>
                </div>

                <div class="terms">
                    <span>UNION 이용 약관에 동의합니다. 마지막 업데이트: 2023년 4월 26일.</span>
                    <span>거래를 시작하기 위한 새로운 웹 브라우저를 열기 위해 아래에 있는 버튼을 클릭하세요.</span>
                </div>

                <a href="#" class="confirm-btn">결제</a>
            </div>
            <div class="container2">
                <p>UNION에서 구매</p>
                <p>이 거래를 완료하면 사용한 결제 수단으로 금액이 차감되며 구매가 완료됩니다.</p>
            </div>
        </div>
    </section>

    <footer>
        <script>loadHTML("./footer.html")</script>
    </footer>
    <!-- 로그인 체크 js 추가 -->
    <script src="../assets/js/checkLogin.js"></script>
    <script>
        /* 구매하기 버튼 동작 => 결제테이블안에 넣고 장바구니 테이블 비우기 */
        document.addEventListener('DOMContentLoaded', () => {
            const paymentButton = document.getElementById('pay');

            if (paymentButton) {
                paymentButton.addEventListener('click', () => {
                    const userId = sessionStorage.getItem('loggedInUser');

                    fetch(`http://localhost:3000/api/cart?userId=${userId}`)
                        .then(response => response.json())
                        .then(cartItems => {
                            cartItems.forEach(item => {
                            });

                            const paymentData = cartItems.map(item => ({
                                gameId: item.gameId,
                                amount: item.price
                            }));


                            // 결제 요청 전송
                            fetch(`http://localhost:3000/api/payment`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    userId: userId,
                                    paymentItems: paymentData
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('결제가 완료되었습니다!');


                                    } else {
                                        alert('결제에 실패했습니다.');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });
                        })
                        .catch(error => {
                            console.error('장바구니 데이터를 가져오는 중 오류:', error);
                        });
                });
            }
        });
    </script>
</body>

</html>