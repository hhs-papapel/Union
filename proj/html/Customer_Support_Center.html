<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객센터</title>
    <link rel="stylesheet" href="../css/Customer_Support_Center.CSS">
    <link rel="stylesheet" href="../css/inquiry.css">
    <script>
        function loadHTML(file) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200 || rawFile.status == 0) {
                        var allText = rawFile.responseText;
                        document.write(allText);
                    }
                }
            }
            rawFile.send(null);
        }
    </script>
</head>

<body>

    <div class="cd-popup" id="cd-popup" role="alert">
        <div class="cd-popup-container">
              <!-- 문의 등록 폼 -->
              <section id="inquiry-form" class="inquiry-form">
                  <h2>문의 등록</h2>
                  <p>어떠한 내용이라도 답변드릴 준비가 되어 있습니다! 문의를 보내주세요! 가능한 한 빨리 답변 드리도록 하겠습니다.</p>
                  <!-- <form action="/submit-inquiry" method="POST"> -->
                      <label for="category">1. 어떤 문제를 겪고 계신가요?</label>
                      <select id="category" name="category">
                          <option value="game-issue">플레이어 신고하기</option>
                          <option value="system-issue">시스템 문제 해결</option>
                          <option value="account-issue">계정 및 보안</option>
                          <option value="payment-issue">결제 및 RP 문제</option>
                      </select>
          
                      <label for="subject">문의 제목</label>
                      <input type="text" id="subject" name="subject" required>
          
                      <label for="description">문의 내용을 상세히 적어주세요</label>
                      <textarea id="description" name="description" rows="5" required></textarea>

                      <button type="button" class="submit-btn" onclick="supportAdd()">제출</button>
                  <!-- </form> -->
              </section>
          <a href="#0" class="cd-popup-close img-replace"></a>
        </div> <!-- cd-popup-container -->
      </div> <!-- cd-popup -->

      

    <header>
        <script>loadHTML("./header.html")</script>
    </header>
    <!-- 상단 배너와 검색창 -->
    <div class="header-banner">
        <div class="search-bar-container">
            <h1>무엇을 도와드릴까요?</h1>
            <input type="text" class="search-input" placeholder="검색어를 입력하세요..." oninput="searchFAQs()">
        </div>
    </div>
    
    <!-- 아이콘 메뉴
    <section class="main-icons">
        <div class="icon-item">
            <img src="../assets/images/결제.png" alt="결제 및 RP 문제">
            <p class="question">결제 및 RP 문제</p>
            <div class="answer">
                <p>RP 충전 문제나 결제 관련 문제는 고객센터에 문의하거나 해당 결제 수단을 다시 확인해 주세요.</p>
            </div>
        </div>
        <div class="icon-item">
            <img src="../assets/images/시스템문제.png" alt="시스템 문제 해결">
            <p class="question">시스템 문제 해결하기</p>
            <div class="answer">
                <p>게임이 제대로 실행되지 않을 경우, 시스템 요구사항을 확인하고 드라이버를 업데이트하세요.</p>
            </div>
        </div>
        <div class="icon-item">
            <img src="../assets/images/계정 보안.png" alt="계정 및 보안">
            <p class="question">계정 및 보안</p>
            <div class="answer">
                <p>계정 도용이 의심되거나 비밀번호를 잊으셨다면 보안 설정에서 비밀번호를 변경하고 고객센터에 문의하세요.</p>
            </div>
        </div>
        <div class="icon-item">
            <img src="../assets/images/플레이어신고.png" alt="게임 종료 후 플레이어 신고">
            <p class="question">게임 종료 후 플레이어 신고하기</p>
            <div class="answer">
                <p>게임 종료 후 플레이어를 신고하려면 리플레이를 확인하고 신고 기능을 통해 문제를 보고하세요.</p>
            </div>
        </div>
    </section> -->


    <section class="qa">
        <h2>많이 하는 질문 TOP4</h2>

    </section>
    <!-- 세부 카테고리 -->
    <section class="help-categories">
        <h2>도움이 필요한 유형을 선택해주세요.</h2>
        <div class="category-grid">
            <div class="category-item" data-category="1-10">계정 정보 및 보안</div>
            <div class="category-item" data-category="11-20">게임, 명예, 점수 및 랭킹</div>
            <div class="category-item" data-category="21-30">성능, 하드웨어 문제, 버그</div>
            <div class="category-item" data-category="31-40">로그인, 패치, 연결 및 충돌</div>
            <div class="category-item" data-category="41-50">상점, 신용카드 및 구독</div>
            <div class="category-item" data-category="51-60">이벤트, 상품 및 기타</div>
        </div>
    </section>

    <!-- 문의하기 -->
    <!-- 문의하기 버튼 섹션 추가 -->
    <section class="inquiry-section" id="inquiry-section">
        <h2>원하는 내용을 찾을 수 없으셨나요?</h2>
        <p>어떠한 내용이라도 답변드릴 준비가 되어 있습니다! 문의를 보내주세요! 가능한 한 빨리 답변 드리도록 하겠습니다.<br>
            문의하신 기록을 보고싶으시다면 <a href="/proj/html/inquiry2.html">이곳</a>을 클릭해주세요
        </p>
        
        <a class=" inquiry-btn btn " id="cd-popup-trigger" onclick="popup()"><span>문의하기</span></a> <!-- <a> 태그 사용 -->
        
    </section>

    <footer>
        <script>loadHTML("./footer.html")</script>
    </footer>



    <!-- 로그인 체크 js 추가 -->
    <script src="../assets/js/checkLogin.js"></script>

    <script>
        
        // 모든 질문을 선택
        const questions = document.querySelectorAll('.question');

    </script>
    <script>
        
        document.addEventListener('DOMContentLoaded', function () {
           


            // 카테고리를 선택하면 FAQ 데이터를 불러와서 갱신하는 함수
            function loadFAQByCategory(startId, endId, categoryTitle = '많이 하는 질문 TOP4') {
                const qaSection = document.querySelector('.qa');
                let h2Element = qaSection.querySelector('h2');

                // h2 요소가 없다면 새로 추가
                if (!h2Element) {
                    h2Element = document.createElement('h2');
                    qaSection.prepend(h2Element);
                }

                h2Element.textContent = categoryTitle; // 제목을 해당 카테고리로 변경

                qaSection.innerHTML = ''; // 기존 질문을 모두 제거

                // h2를 다시 추가 (모든 내용이 지워졌으므로)
                qaSection.prepend(h2Element);

                // 선택된 카테고리의 FAQ를 불러오기
                fetch(`http://localhost:3000/api/faqs?startId=${startId}&endId=${endId}`)
                    .then(response => response.json())
                    .then(data => {
                        // 데이터가 성공적으로 받아지면, 해당 FAQ 항목들을 동적으로 삽입
                        data.forEach(faq => {
                            const qaItem = document.createElement('div');
                            qaItem.classList.add('qa-item');

                            const question = document.createElement('p');
                            question.classList.add('question');
                            question.textContent = `Q${faq.faqId}. ${faq.question}`;

                            const answerDiv = document.createElement('div');
                            answerDiv.classList.add('answer');
                            answerDiv.style.display = 'none';  // 기본적으로 숨김
                            const answerText = document.createElement('p');
                            answerText.textContent = `A${faq.faqId}. ${faq.answer}`;

                            answerDiv.appendChild(answerText);
                            qaItem.appendChild(question);
                            qaItem.appendChild(answerDiv);
                            qaSection.appendChild(qaItem);

                            // 클릭 시 답변을 토글하는 이벤트
                            question.addEventListener('click', () => {
                                answerDiv.style.display = answerDiv.style.display === 'block' ? 'none' : 'block';
                            });
                        });
                    })
                    .catch(error => {
                        console.error('FAQ 데이터를 불러오는 중 오류 발생:', error);
                    });

                    const userId = sessionStorage.getItem('loggedInUser');
                    console.log(userId);
                    const inquirySection = document.getElementById('inquiry-section');
                    if (userId) {
                        inquirySection.style.display = 'inline';
                    }else{
                        inquirySection.style.display = 'none';
                    }
            }

            // 카테고리 클릭 이벤트 추가
            const categories = document.querySelectorAll('.category-item');
            const categoryRanges = [
                { startId: 1, endId: 10 },    // 계정 정보 및 보안
                { startId: 11, endId: 20 },   // 게임, 명예, 점수 및 랭킹
                { startId: 21, endId: 30 },   // 성능, 하드웨어 문제, 버그
                { startId: 31, endId: 40 },   // 로그인, 패치, 연결 및 충돌
                { startId: 41, endId: 50 },   // 상점, 신용카드 및 구독
                { startId: 51, endId: 60 }    // 이벤트, 상품 및 기타
            ];
            const categoryTitles = [
                '계정 정보 및 보안',
                '게임, 명예, 점수 및 랭킹',
                '성능, 하드웨어 문제, 버그',
                '로그인, 패치, 연결 및 충돌',
                '상점, 신용카드 및 구독',
                '이벤트, 상품 및 기타'
            ];

            categories.forEach((category, index) => {
                category.addEventListener('click', () => {
                    const { startId, endId } = categoryRanges[index];
                    const categoryTitle = categoryTitles[index];
                    loadFAQByCategory(startId, endId, categoryTitle);
                });
            });

            // 페이지 로드 시 기본적으로 61~64번 질문을 로드하고 제목을 '많이 하는 질문 TOP4'로 설정
            loadFAQByCategory(61, 64, '많이 하는 질문 TOP4');
        });

        function searchFAQs() {
            const query = document.querySelector('.search-input').value.trim();
            const qaSection = document.querySelector('.qa');

            if (query.length < 2) {
                return;  // 최소 2글자 입력 시부터 검색 시작
            }

            qaSection.innerHTML = '';  // 기존 질문 목록 삭제

            fetch(`http://localhost:3000/api/faqs/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        qaSection.innerHTML = '<p>검색 결과가 없습니다.</p>';
                        return;
                    }

                    // 데이터가 성공적으로 받아지면, 해당 FAQ 항목들을 동적으로 삽입
                    data.forEach(faq => {
                        const qaItem = document.createElement('div');
                        qaItem.classList.add('qa-item');

                        const question = document.createElement('p');
                        question.classList.add('question');
                        question.textContent = `Q${faq.faqId}. ${faq.question}`;

                        const answerDiv = document.createElement('div');
                        answerDiv.classList.add('answer');
                        answerDiv.style.display = 'none';  // 기본적으로 숨김
                        const answerText = document.createElement('p');
                        answerText.textContent = `A${faq.faqId}. ${faq.answer}`;

                        answerDiv.appendChild(answerText);
                        qaItem.appendChild(question);
                        qaItem.appendChild(answerDiv);
                        qaSection.appendChild(qaItem);

                        // 클릭 시 답변을 토글하는 이벤트
                        question.addEventListener('click', () => {
                            answerDiv.style.display = answerDiv.style.display === 'block' ? 'none' : 'block';
                        });
                    });
                })
                .catch(error => {
                    console.error('검색 결과를 불러오는 중 오류 발생:', error);
                });
        }
    </script>
<script src="/proj/assets/lib/jquery-3.7.1.min.js"></script>
<script>
    jQuery(document).ready(function($){
  //open popup
  $('#cd-popup-trigger').on('click', function(event){
    event.preventDefault();
    $('.cd-popup').addClass('is-visible');
  });
  
  //close popup
  $('.cd-popup').on('click', function(event){
    if( $(event.target).is('.cd-popup-close') || $(event.target).is('.cd-popup') ) {
      event.preventDefault();
      $(this).removeClass('is-visible');
    }
  });
  //close popup when clicking the esc keyboard button
  $(document).keyup(function(event){
      if(event.which=='27'){
        $('.cd-popup').removeClass('is-visible');
      }
    });
});

    function supportAdd(){
        const id = sessionStorage.getItem('loggedInUser');

        const subject = document.getElementById('subject');
        const content = document.getElementById('description');

        if(subject.value==''){
                alert('제목을 입력해주세요');
                subject.focus();
                return;
            }
            if(content.value==''){
                alert('내용을 입력해주세요');
                content.focus();
                return;
            }

        let supportData = {
                id: id,
                subject: subject.value,
                content: content.value
            };
        $.ajax({
            url: 'http://localhost:3000/support/add',
            type: 'POST',
            contentType: 'application/json', // 데이터를 JSON 형식으로 전송
            data: JSON.stringify(supportData),   // 객체를 JSON 문자열로 변환하여 전송
            dataType: 'json',
            success: function (res) {
                if (res.status === 200) {
                    alert('문의등록 성공!');
                    subject.value = "";
                    content.value = "";
                    $('.cd-popup').removeClass('is-visible');
                } else if (res.status === 409) {
                    alert('문의등록 중 오류가 발생했습니다.');
                }
            },
            error: function () {
                alert('문의등록 중 오류가 발생했습니다.');
            }
        });
    }
</script>
</body>

</html>