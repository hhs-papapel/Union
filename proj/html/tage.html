<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tagtitle">무료 플레이 게임</title>
    <link rel="stylesheet" href="../css/tage.css">
    <script>
        function loadHTML(file) {
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", file, false);
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200 || rawFile.status == 0) {
                        var allText = rawFile.responseText;
                        document.write(allText);
                    }
                }
            }
            rawFile.send(null);
        }
    </script>
</head>

<body>
    <header>
        <script>loadHTML("./header.html")</script>
    </header>

    <!-- <header class="top-menu">
        <div class="section-indicator">
            <h3>Section 3</h3>
        </div>
        <nav class="menu-bar">
            <ul>
                <li>신규 목록</li>
                <li>신규 목록</li>
                <li>신규 목록</li>
                <li>신규 목록</li>
            </ul>
        </nav>
    </header>
    <br><br> -->

    <!-- <section class="mid-menu">
        <nav class="mid-menu-bar">
            <ul>
                <li>신규 게임 목록</li>
                <li>신규 업데이트</li>
                <li>신규 팩 출시</li>
                <li>신규 모드</li>
            </ul>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="검색">
            </div>
        </nav>
    </section> -->
    <section class="main-content">
        <div class="section-title">
            <h2 id="tagtitlee"></h2>
        </div>

        <div class="game-card"  id="searchResults">
            <div class="game-image">
                <img src="./header.jpg" alt="Team Fortress 2 이미지" id="taggameimg">
            </div>
            <div class="game-info">
                <h3 id="taggamename"></h3>
                <p id="taggamedate"></p>
                <p class="game-reviews"></p>
                <div class="tags" id="taggametag">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="recommendation">
                    추천 이유:
                    <ul id="recommendation-list">
                        <!-- 랜덤 추천 이유가 들어갈 자리 -->
                    </ul>
                </div>
            </div>
        </div>
    </section>
    <br>


    <section class="tags">

        <div class="tag-container">
            <a href="/proj/html/tage.html?tagId=22"><button class="tag-button">무료 플레이</button></a>
            <a href="/proj/html/tage.html?tagId=1"><button class="tag-button">액션</button></a>
            <a href="/proj/html/tage.html?tagId=2"><button class="tag-button">어드벤처</button></a>
            <a href="/proj/html/tage.html?tagId=3"><button class="tag-button">롤플레잉</button></a>
            <a href="/proj/html/tage.html?tagId=4"><button class="tag-button">전략</button></a>
            <a href="/proj/html/tage.html?tagId=5"><button class="tag-button">인디</button></a>
            <a href="/proj/html/tage.html?tagId=6"><button class="tag-button">캐주얼</button></a>
            <a href="/proj/html/tage.html?tagId=7"><button class="tag-button">시뮬레이션</button></a>
        </div>
        <br>
        <div class="tag-container">
            <a href="/proj/html/tage.html?tagId=8"><button class="tag-button">공포</button></a>
            <a href="/proj/html/tage.html?tagId=9"><button class="tag-button">멀티플레이어</button></a>
            <a href="/proj/html/tage.html?tagId=10"><button class="tag-button">협동 플레이</button></a>
            <a href="/proj/html/tage.html?tagId=11"><button class="tag-button">싱글플레이어</button></a>
            <a href="/proj/html/tage.html?tagId=12"><button class="tag-button">오픈 월드</button></a>
            <a href="/proj/html/tage.html?tagId=13"><button class="tag-button">퍼즐</button></a>
            <a href="/proj/html/tage.html?tagId=14"><button class="tag-button">생존</button></a>
            <a href="/proj/html/tage.html?tagId=15"><button class="tag-button">SF</button></a>
        </div>
        <br>
        <div class="tag-container">
            <a href="/proj/html/tage.html?tagId=16"><button class="tag-button">판타지</button></a>
            <a href="/proj/html/tage.html?tagId=17"><button class="tag-button">플랫포머</button></a>
            <a href="/proj/html/tage.html?tagId=18"><button class="tag-button">1인칭</button></a>
            <a href="/proj/html/tage.html?tagId=19"><button class="tag-button">3인칭</button></a>
            <a href="/proj/html/tage.html?tagId=20"><button class="tag-button">샌드박스</button></a>
        </div>
    </section>

    <section class="photo-grid" id="photoGrid">
        <!-- <div class="photo-item">사진 1</div>
        <div class="photo-item">사진 2</div>
        <div class="photo-item">사진 3</div>
        <div class="photo-item">사진 4</div>
        <div class="photo-item">사진 5</div>
        <div class="photo-item">사진 6</div>
        <div class="photo-item">사진 7</div>
        <div class="photo-item">사진 8</div> -->
    </section>

    <section class="bottomButton">
        <button id="loadMoreButton">더보기</button>
    </section>

    <footer>
        <script>loadHTML("./footer.html")</script>
    </footer>

    <!-- 로그인 체크 js 추가 -->
    <script src="../assets/js/checkLogin.js"></script>

    <script>
        // URL에서 tagId를 가져오는 함수
        function getTagIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('tagId');  // 'tagId' 파라미터 값 가져오기
        }



        // 태그에 맞는 정보를 로드하고 제목을 업데이트하는 함수
        function loadTagInfo(tagId) {

            fetch(`http://localhost:3000/api/tag/${tagId}`)
                .then(response => {

                    if (!response.ok) {
                        throw new Error('서버 응답이 올바르지 않습니다.');
                    }
                    return response.json();
                })
                .then(data => {

                    if (data && data.tagName) {
                        document.getElementById('tagtitle').innerHTML = `${data.tagName} 게임`;  // <title> 변경
                        document.getElementById('tagtitlee').innerHTML = `${data.tagName} 게임`;  // <h2> 변경
                    }
                })
                .catch(error => {
                    console.error('태그 데이터를 불러오는 중 오류 발생:', error);
                });
        }





        document.addEventListener('DOMContentLoaded', () => {
            // 태그 ID 가져오기
            const tagId = getTagIdFromURL();

            // 태그 ID가 있을 경우, 태그 정보를 로드하여 제목 업데이트
            if (tagId) {
                loadTagInfo(tagId);
                loadRandomGame(tagId);  // 태그 ID를 인자로 넘겨줌
            } else {
                console.error('태그 ID를 찾을 수 없습니다.');
            }
        });




        /*───────────────────────────────────────────────────────────────────────────────────────────*/

        document.addEventListener('DOMContentLoaded', () => {
            const tagId = getTagIdFromURL();
            if (tagId) {
                fetchRandomGame(tagId);  // 태그에 맞는 랜덤 게임 로드
            } else {
                console.error('tagId를 찾을 수 없습니다.');
            }
        });

        function getTagIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('tagId');
        }

        // 랜덤 게임 가져오기
        function fetchRandomGame(tagId) {
            fetch(`http://localhost:3000/api/games/tag/${tagId}/random`)
                .then(response => response.json())
                .then(game => {

                    // 게임 정보를 HTML에 표시
                    document.getElementById('taggamename').innerText = game.gameName;
                    document.getElementById('taggamedate').innerText = `출시일: ${new Date(game.releaseDate).toLocaleDateString()}`;

                    // 이미지 변경
                    const gameImage = document.getElementById('taggameimg');
                    gameImage.src = game.imageUrl;
                    gameImage.alt = `${game.gameName} 이미지`;

                    // 이미지를 클릭하면 해당 게임의 상세 페이지로 이동
                    gameImage.addEventListener('click', () => {
                        window.location.href = `/proj/html/game_details.html?gameId=${game.gameId}`;
                    });

                    fetchGameTags(game.gameId);
                })
                .catch(error => console.error('랜덤 게임을 가져오는 중 오류:', error));
        }

        // 게임에 연결된 태그 가져오기
        function fetchGameTags(gameId) {
            fetch(`http://localhost:3000/api/games/${gameId}/tags`)
                .then(response => response.json())
                .then(tags => {
                    const tagContainer = document.getElementById('taggametag');
                    tagContainer.innerHTML = '';  // 기존 태그 초기화

                    // 받아온 태그들을 순회하면서 HTML에 추가
                    tags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.textContent = tag;
                        tagContainer.appendChild(tagElement);
                    });
                })
                .catch(error => console.error('태그를 가져오는 중 오류:', error));
        }

        /*───────────────────────────────────────────────────────────────────────────────────────────*/

        const recommendations = [
            "흥미진진한 게임 플레이가 당신을 사로잡을 것입니다.",
            "독창적인 액세서리가 게임 몰입도를 높여줍니다.",
            "이 게임은 최근에 매우 긍정적인 평가를 받았습니다.",
            "나의 게임 취향과 일치하는 최고의 선택!",
            "다른 유저들이 강력하게 추천하는 게임입니다.",
            "몰입감 넘치는 스토리와 놀라운 그래픽이 매력적입니다.",
            "환상적인 사운드와 게임 플레이가 매력적입니다.",
            "다양한 게임 모드가 준비되어 있어, 지루할 틈이 없습니다.",
            "게임의 스토리가 깊이 있게 구성되어 감동을 선사합니다.",
            "높은 자유도 덕분에 원하는 대로 즐길 수 있는 게임입니다.",
            "플레이어 커뮤니티에서 매우 높은 평점을 기록하고 있습니다.",
            "화려한 비주얼과 박진감 넘치는 전투가 돋보입니다.",
            "세계관이 독창적이고, 몰입하기 좋습니다.",
            "다양한 캐릭터와 상호작용할 수 있는 흥미로운 요소가 많습니다.",
            "게임 컨트롤이 직관적이어서 쉽게 적응할 수 있습니다.",
            "차세대 그래픽으로 게임의 현실감이 뛰어납니다.",
            "적들을 물리치는 액션이 짜릿하고 도전적입니다.",
            "게임 내 전략적 요소들이 잘 설계되어 있습니다.",
            "짧은 시간 안에 즐길 수 있는 빠른 전개가 매력적입니다.",
            "싱글 플레이 뿐만 아니라 멀티플레이도 훌륭하게 지원됩니다.",
            "다른 플레이어와 협력할 수 있는 재미있는 요소가 포함되어 있습니다.",
            "모든 연령대가 즐길 수 있는 가족 친화적인 게임입니다.",
            "스토리 전개가 예측 불가능하고 놀랍습니다.",
            "캐릭터 커스터마이징이 뛰어나, 자신만의 캐릭터를 만들 수 있습니다.",
            "많은 유저들이 이 게임의 중독성 있는 플레이를 칭찬하고 있습니다.",
            "게임 내 숨겨진 요소들이 많아, 반복 플레이에 재미를 더합니다.",
            "다양한 DLC와 업데이트로 꾸준히 지원됩니다.",
            "플레이어 간의 경쟁이 치열해서 긴장감을 줍니다.",
            "탄탄한 세계관과 설정 덕분에 몰입감이 높습니다.",
            "쉬운 난이도부터 도전적인 난이도까지 다양한 옵션이 제공됩니다.",
            "유명 스트리머들이 추천한 게임으로 큰 인기를 끌고 있습니다.",
            "오프라인에서도 충분히 즐길 수 있는 게임입니다.",
            "인상적인 보스 전투로 끝까지 긴장감을 유지할 수 있습니다.",
            "역동적인 게임 내 날씨와 시간 변화 시스템이 인상적입니다.",
            "오픈 월드에서 탐험할 수 있는 방대한 지역이 매력적입니다.",
            "캐릭터 간의 상호작용이 흥미진진하여 스토리 몰입도가 높습니다.",
            "짧게 즐기기에도, 오랫동안 플레이하기에도 적합한 게임입니다.",
            "매력적인 캐릭터와 흥미로운 스토리가 잘 조화를 이룹니다.",
            "쉽게 배우지만 마스터하기 어려운 게임 메커니즘이 도전적입니다."
        ];

        // 배열을 섞는 함수
        function shuffleArray(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        // 배열을 섞고 첫 번째와 두 번째 추천 이유 선택
        const shuffledRecommendations = shuffleArray(recommendations);

        // 추천 이유를 HTML에 추가
        const recommendationList = document.getElementById('recommendation-list');
        recommendationList.innerHTML = `
            <li>${shuffledRecommendations[0]}</li>
            <li>${shuffledRecommendations[1]}</li>
                `;

        /*───────────────────────────────────────────────────────────────────────────────────────────*/



        let currentPage = 1;
        const itemsPerPage = 8;

        // 게임 목록을 서버에서 가져오는 함수
        function loadGames(page, tagId) {
            console.log(`Loading games for page: ${page}, tagId: ${tagId}`);  // 디버깅용 로그 추가
            fetch(`http://localhost:3000/api/games?tagId=${tagId}&page=${page}&limit=${itemsPerPage}`)
                .then(response => response.json())
                .then(games => {
                    const photoGrid = document.getElementById('photoGrid');

                    // 게임 목록을 순회하며 이미지 추가
                    games.forEach(game => {
                        const gameItem = document.createElement('div');
                        gameItem.classList.add('photo-item');

                        // a 태그를 추가하여 클릭 시 상세 페이지로 이동하게 만듦
                        const gameLink = document.createElement('a');
                        gameLink.href = `/proj/html/game_details.html?gameId=${game.gameId}`;

                        // 배경 이미지 설정
                        gameItem.style.backgroundImage = `url(${game.imageUrl || './default.jpg'})`;
                        gameItem.style.backgroundSize = '100% auto';
                        gameItem.style.backgroundPosition = 'center';
                        gameItem.style.backgroundRepeat = 'no-repeat';

                        // gameItem을 gameLink에 추가
                        gameLink.appendChild(gameItem);
                        photoGrid.appendChild(gameLink);
                    });

                    console.log(`Loaded ${games.length} games.`);  // 로드된 게임 수 로그 출력
                })
                .catch(error => {
                    console.error('게임 목록을 불러오는 중 오류 발생:', error);
                });
        }

        // DOMContentLoaded 이벤트 이후에 "더보기" 버튼 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', () => {
            const tagId = getTagIdFromURL();
            let currentPage = 1;  // 현재 페이지 번호
            const itemsPerPage = 8;  // 한 페이지에 표시할 게임 수

            if (tagId) {
                // 첫 페이지의 게임 목록 로드
                loadGames(currentPage, tagId);
            }

            // "더보기" 버튼 이벤트 리스너 추가
            const loadMoreButton = document.getElementById('loadMoreButton');
            loadMoreButton.addEventListener('click', () => {
                currentPage++;  // 페이지 번호 증가
                console.log(`Loading next page: ${currentPage}`);  // 디버깅용 로그 추가
                loadGames(currentPage, tagId);  // 다음 페이지의 게임 목록 로드
            });
        });


        document.getElementById('loadMoreButton').addEventListener('click', () => {
            currentPage++;
            loadGames(currentPage);
        });

        /*───────────────────────────────────────────────────────────────────────────────────────────*/



        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');

            searchInput.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();  // 엔터키 기본 동작 막음
                    const searchQuery = searchInput.value;
                    if (searchQuery) {
                        searchGames(searchQuery);  // 검색 함수 호출
                    }
                }
            });

            // 검색어에 맞는 게임을 서버에서 가져오는 함수
            function searchGames(query) {
                fetch(`http://localhost:3000/api/games/search?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(games => {
                        const searchResults = document.getElementById('searchResults');
                        if (!searchResults) {
                            console.error('searchResults 요소를 찾을 수 없습니다.');
                            return;
                        }

                        searchResults.innerHTML = '';  // 기존 검색 결과 초기화

                        if (games.length === 0) {
                            searchResults.innerHTML = '<p>검색 결과가 없습니다.</p>';
                            return;
                        }

                        // 검색 결과가 있을 때마다 해당 게임 정보를 동적으로 추가
                        games.forEach(game => {
                            
                            // game.tags가 null 또는 undefined인 경우 빈 배열로 대체하고, 쉼표로 구분된 문자열을 배열로 변환
                            const gameTags = game.tags ? game.tags.split(',').map(tag => `<span>${tag}</span>`).join(' ') : '';

                            // 추천 이유를 무작위로 두 개 선택
                            const shuffledRecommendations = shuffleArray(recommendations);
                            const randomReasons = `
                        <li>${shuffledRecommendations[0]}</li>
                        <li>${shuffledRecommendations[1]}</li>
                    `;

                            const gameCard = `
                        <div class="game-card">
                            <div class="game-image">
                                <img src="${game.imageUrl || './default.jpg'}" alt="${game.gameName} 이미지">
                            </div>
                            <div class="game-info">
                                <h3>${game.gameName}</h3>
                                <p>출시일: ${new Date(game.releaseDate).toLocaleDateString()}</p>
                                <div class="tags">
                                    ${gameTags}
                                </div>
                                <div class="recommendation">
                                    추천 이유:
                                    <ul>
                                        ${randomReasons}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;

                            // 게임 카드 요소를 동적으로 searchResults에 추가
                            searchResults.innerHTML += gameCard;
                        });

                        // 검색 결과에 맞는 제목도 업데이트 (첫 번째 검색 결과에 맞는 제목으로 변경)
                        
                    })
                    .catch(error => {
                        console.error('검색 중 오류 발생:', error);
                        const searchResults = document.getElementById('searchResults');
                        if (searchResults) {
                            searchResults.innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
                        }
                    });
            }
        });


    </script>

</body>

</html>